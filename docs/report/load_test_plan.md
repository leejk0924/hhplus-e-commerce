# 부하 테스트 계획서

## 1. 배경

본 서비스는 상품 조회, 주문, 결제 등 비즈니스 핵심 기능을 포함하고 있으며, 특회 선착순 쿠폰 발급 등 단기간 높은 트래픽이 집중될 것으로 예상 되는 부분이 있습니다.
운영 환경 진입 전 시스템이 이러한 부하를 안정적으로 처리할 수 있는지 테스트를 진행하여 시스템의 성능과 안정성을 검증하고자 한다.
따라서 단순 성능 측정이 아니라, 실제 운영 환경에서 발생할 수 있는 문제를 사전에 식별하고, 장애 발생 가능성을 미리 줄이고 서비스 안정성을 확보하는 예방 조치로서 수행한다.

## 2. 대상 선정

### 2.1. 상품 상세 조회 기능 (/api/products/{productId})

이번 부하 테스트의 주요 대상 중 하나로 **상품 상세 조회 기능**을 선정한 근거는 다음과 같습니다:

- **트래픽 집중도**: 전체 API 호출의 약 40-50%를 차지하는 최고 빈도 API로, 모든 구매 프로세스의 시작점
- **사용자 경험 직결**: 상품 상세 페이지 로딩 지연은 즉시 이탈률 증가로 이어지며, 1초 지연 시 전환율 7% 감소
- **캐시 의존성**: Redis 캐시 성능이 직접적으로 영향을 미치는 대표적 API로, 캐시 실패 시 DB 부하 급증
- **비즈니스 영향**: 상품 조회 실패/지연은 전체 구매 여정 차단으로 이어져 매출에 직접적 타격
- **확장성 검증**: 상품 카탈로그 증가에 따른 성능 저하 여부 및 인덱스 최적화 효과 검증 필요

### 2.2. 쿠폰 발급 기능 (/api/coupons/issue)

**쿠폰 발급 기능**을 부하 테스트 대상으로 선정한 근거는 다음과 같습니다:

- **동시성 이슈**: 한정된 쿠폰에 대한 동시 발급 요청 시 race condition 및 중복 발급 위험성 검증 필요
- **이벤트 트래픽**: 플래시 세일, 한정 프로모션 등에서 순간적으로 급증하는 트래픽 패턴의 대표 사례
- **비즈니스 임계성**: 쿠폰 발급 실패는 고객 불만 및 브랜드 신뢰도 하락으로 직결, 특히 마케팅 캠페인 효과 저해
- **분산 처리 검증**: Kafka 기반 비동기 처리 및 Redis 분산 락 메커니즘의 성능과 안정성 검증
- **재고 관리**: 쿠폰 재고 차감 로직의 원자성 보장 및 오버셀링 방지 기능 테스트
- **데이터 정합성**: 대량 발급 시에도 쿠폰 상태 관리 및 사용자 발급 이력의 일관성 유지 검증


## 3. 테스트 환경

### 3-1. 인프라 구성

| 구분             | 서비스             | 버전    | 포트 | 사양                     |
| ---------------- |-----------------|-------| ---- |------------------------|
| **애플리케이션** | Spring Boot API | 3.4.1 | 8080 | CPU 2Core, Memory 16GB |
| **데이터베이스** | MySQL           | 8.0   | 3306 | -                      |
|                  | Redis           | 8.2.1 | 6379 | -                      |
| **메시징**       | Kafka (bitnami) | 3.7.0 | 9092 | -                      |

이러한 대용량 데이터 환경에서 실제 운영 상황과 유사한 부하 테스트를 수행할 예정입니다.

## 4. 테스트 도구

### 4-1. 부하 테스트 도구

**K6**를 주요 부하 테스트 도구로 선정하였습니다.

**K6 선정 이유:**

- **JavaScript 기반**: 시나리오 작성이 용이하고 복잡한 테스트 로직 구현 가능
- **가벼운 아키텍처**: Go로 개발되어 높은 성능과 낮은 리소스 사용량
- **풍부한 메트릭**: TPS, 응답시간, 에러율 등 다양한 성능 지표 자동 수집
- **시나리오 유연성**: 단계별 부하 증가, 스파이크 테스트 등 다양한 패턴 지원

**각 부하테스트 도구 비교**

| 도구 | 특징 | 강점 | 한계 | 추천 용도 |
|------|------|------|------|----------|
| **k6** | JavaScript DSL | Threshold 내장<br>Prometheus 연동<br>gRPC/WebSocket 지원 | GUI 없음<br>학습 곡선 존재 | 마이크로서비스<br>CI/CD 자동화 |
| **JMeter** | GUI 기반 | 다양한 프로토콜<br>레거시 지원<br>GUI 직관적 | 리소스 소모 큼<br>스크립트 관리 복잡 | 레거시 시스템<br>빠른 프로토타입 |
| **Gatling** | Scala DSL | 고성능<br>코드 리뷰 용이<br>JVM 통합 | HTTP 중심<br>JVM 언어 필요 | Java 생태계<br>고성능 HTTP 테스트 |
| **Locust** | Python | 분산 실행 간단<br>Python 라이브러리 활용 | 커스텀 프로토콜 제한 | Python 팀<br>분산 부하 테스트 |


### 4-2. 모니터링 및 시각화

**InfluxDB + Grafana** 조합으로 실시간 모니터링 및 시각화를 구성하였습니다.

**InfluxDB (1.8.10)**

- K6 테스트 결과를 실시간으로 수집 및 저장
- 시계열 데이터베이스로 성능 메트릭 최적화
- Port 8086으로 K6와 연동

**Grafana (12.1.1)**

- InfluxDB 데이터를 기반으로 실시간 대시보드 구성
- TPS, 응답시간, 에러율, 시스템 리소스 사용률 시각화
- Port 3000으로 웹 기반 모니터링 제공
- 테스트 진행 중 실시간 성능 지표 확인 가능

이를 통해 테스트 실행 중 실시간으로 성능 지표를 모니터링하고, 시스템 임계점을 즉시 파악할 수 있습니다.

## 5. 테스트 시나리오

### 5-1. 쿠폰 발급 시나리오

선착순 쿠폰 발급에 대한 대량 트래픽 상황을 시뮬레이션하는 테스트 시나리오입니다.

**시나리오 개요:**
- 한정된 쿠폰에 대한 동시 발급 요청으로 실제 마케팅 이벤트 상황 재현
- Kafka 기반 비동기 처리와 Redis 분산락의 성능 및 안정성 검증
- 대량 요청 상황에서의 쿠폰 재고 관리 및 데이터 정합성 확인

**부하 패턴:**
- 30초간 1000명까지 선형 증가 (스파이크 트래픽 시뮬레이션)
- 1분간 1000명 유지 (피크 부하 지속)

**성능 임계값:**
- 95% 응답시간: 5초 미만
- 체크 성공률: 100% (비즈니스 로직 관점)

### 5-2. 주문/결제 통합 시나리오

실제 사용자의 구매 여정을 시뮬레이션하는 **End-to-End 테스트 시나리오**입니다.

**부하 패턴:**
- 10초간 80명까지 증가
- 1분간 100명 유지 (일반적인 쇼핑몰 트래픽)
- 10초간 80명으로 감소

**성능 임계값:**
- 95% 응답시간: 500ms 미만
- 실패율: 5% 미만

**테스트 시나리오 단계:**
1. **랜덤 유저 선택**: 1~1,000,000 중 랜덤 사용자 ID 생성
2. **인기 상품 조회**: 상위 10개 인기 상품 목록 조회
3. **상품 선택**: 인기 상품 중 랜덤으로 1개 선택
4. **상품 상세 조회**: 선택된 상품의 옵션 정보 포함 상세 조회
5. **쿠폰 조회**: 해당 사용자의 발급된 쿠폰 목록 조회
6. **주문 생성**: 상품 옵션 + 쿠폰 적용하여 주문 생성

## 6. 측정 지표 및 모니터링

### 6-1. 성능 지표 (Performance Metrics)
- **Response Time**: 평균, 95%ile, 99%ile 응답 시간
- **Throughput**: RPS (Requests Per Second) 처리량
- **Error Rate**: HTTP 4xx, 5xx 에러 비율
- **Concurrent Users**: 동시 접속 사용자 수

### 6-2. 시스템 리소스 지표
- **CPU 사용률**: 애플리케이션 서버, 데이터베이스 서버
- **Memory 사용률**: JVM 힙 메모리, 시스템 메모리
- **Database Connection Pool**: 활성/대기 커넥션 수
- **Redis 성능**: Cache hit ratio, 연결 수, 메모리 사용량

### 6-3. 애플리케이션 지표
- **JVM 지표**: GC 시간, 힙 사용률, 스레드 수
- **Database 지표**: 슬로우 쿼리, 커넥션 대기 시간
- **Kafka 지표**: 프로듀서/컨슈머 지연 시간, 큐 적재량

## 7. 예상 리스크 및 대응 방안

### 7-1. 예상 리스크
1. **Database Connection Pool 고갈**
   - HikariCP 최대 커넥션 수: 3개 (현재 설정)
   - 높은 부하 시 커넥션 부족으로 인한 대기 시간 증가

2. **Redis 메모리 부족**
   - 캐시 데이터 증가로 인한 메모리 부족 및 eviction 정책 동작

3. **Kafka 처리 지연**
   - 쿠폰 발급 요청 대량 유입 시 메시지 적재 및 처리 지연

4. **쿠폰 재고 동시성 이슈**
   - 분산락 경합으로 인한 응답 시간 증가 및 timeout 발생

### 이건 나중에 작성 
### 7-2. 대응 방안
1. **커넥션 풀 최적화**
   - 부하 테스트 결과 기반 적정 커넥션 수 조정
   - 커넥션 타임아웃 설정 최적화

2. **캐시 정책 개선**
   - Redis TTL 설정 최적화
   - 메모리 한도 설정 및 LRU eviction 정책 적용

3. **Kafka 성능 튜닝**
   - 파티션 수 증가로 병렬 처리 능력 향상
   - 컨슈머 그룹 설정 최적화

4. **분산락 최적화**
   - Redis 분산락 타임아웃 설정 조정
   - 쿠폰 발급 로직 성능 개선

## 8. 성공 기준

### 8-1. 쿠폰 발급 시나리오 성공 기준
- **응답 시간**: 95%ile < 5초
- **처리량**: 1000 RPS 이상 처리 가능
- **데이터 정합성**: 쿠폰 중복 발급 0건
- **시스템 안정성**: 테스트 완료 후 정상 서비스 복구

### 8-2. 통합 시나리오 성공 기준
- **응답 시간**: 95%ile < 500ms
- **에러율**: 5% 미만
- **처리량**: 100 RPS 이상 안정적 처리
- **가용성**: 99.9% 이상 유지

## 9. 테스트 실행 계획

### 9-1. 사전 준비
- K6 스크립트 작성 및 검증 완료
- 모니터링 환경 구축 (InfluxDB + Grafana)
- 테스트 데이터 준비 (사용자, 상품, 쿠폰)

### 9-2. 테스트 실행 순서
1. **쿠폰 발급 단독 테스트**: 동시성 및 처리량 검증
2. **주문/결제 통합 테스트**: End-to-End 워크플로우 검증
3. **혼합 시나리오 테스트**: 실제 운영 환경 시뮬레이션

### 9-3. 결과 분석 및 개선
- 실시간 모니터링을 통한 병목 지점 식별
- 테스트 결과 데이터 수집 및 분석
- 성능 개선 방안 도출 및 적용 검토

이 부하 테스트를 통해 시스템의 성능 한계를 파악하고, 실제 서비스 운영에 필요한 최적화 인사이트를 도출할 예정입니다.