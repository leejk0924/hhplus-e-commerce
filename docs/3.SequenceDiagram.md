# μ‹ν€€μ¤ λ‹¤μ΄μ–΄κ·Έλ¨ (Sequence Diagram)

κ° κΈ°λ¥λ³„ μ‹ν€€μ¤ λ‹¤μ΄μ–΄κ·Έλ¨μ„ ν†µν•΄ ν•΄λ‹Ή μ„λΉ„μ¤μ μ΄ν•΄λ¥Ό λ•κ³ μ ν•¨.
--

## μ„¤κ³„ λ¬Έμ„
- [1. μ”κµ¬μ‚¬ν•­λ…μ„Έμ„](/docs/1.Requireements.md)
- [2. ERD](/docs/2.ERD.md)
- [2-1 DDL](/src/main/resources/schema.sql)
- [3. μ‹ν€€μ¤ λ‹¤μ΄μ–΄κ·Έλ¨](/docs/3.SequenceDiagram.md)
- [4. APIλ…μ„Έ](/docs/4.APISpec.png)


##  π“ ν¬μΈνΈ
### ν¬μΈνΈ μ΅°ν
```mermaid
sequenceDiagram
    autonumber
    participant A as UserPointController
    participant B as UserPointService
    participant C as UserPointRepository
    A->>+B: ν¬μΈνΈ μ΅°ν μ”μ²­
    B->>+C: ν¬μΈνΈ μ΅°ν
    C-->>-B: ν¬μΈνΈ μ΅°ν κ²°κ³Ό λ°ν™
    alt
        B-->>A: μ”μ•΅μ΄ μ—†λ” κ²½μ° 0μ›
    else
        B-->>-A : μ μ €μ λ³΄μ  ν¬μΈνΈ
    end
```
#### μ£Όμ” λ‚΄μ© μ”μ•½
- 4οΈβƒ£: λ°ν™λ ν¬μΈνΈκ°€ μ—†μ„ μ‹ 0μ„ λ°ν™

### ν¬μΈνΈ μ¶©μ „
```mermaid
sequenceDiagram
    autonumber
    participant A as UserPointController
    participant B as UserPointService
    participant C as UserPointRepository
    participant D as PointHistoryRepository

    A->>+B: ν¬μΈνΈ μ¶©μ „ μ”μ²­
    B->>+C: μ”μ—¬ ν¬μΈνΈ μ΅°ν
    C-->>-B: ν¬μΈνΈ μ΅°ν κ²°κ³Ό λ°ν™
    B ->> B: ν¬μΈνΈ μ΅°ν κ²°κ³Όμ— ν¬μΈνΈ μ¶©μ „
    alt μ¶©μ „ ν›„ ν¬μΈνΈκ°€ 0 λ―Έλ§, 1000λ§μ› μ΄κ³ΌμΈ κ²½μ°
        B -->> A: μ¶©μ „ μ‹¤ν¨
    else ν•©μ‚°ν• ν¬μΈνΈκ°€ 0μ΄μƒ, 1000λ§μ› μ΄ν•μΈ κ²½μ°
        B->>+C: μ¶©μ „λ ν¬μΈνΈ DBμ— μ €μ¥
        C-->>-B: μ €μ¥ μ™„λ£ μ‘λ‹µ
        B->>+D: ν¬μΈνΈ μ¶©μ „ λ‚΄μ—­ μ €μ¥
        D-->>-B: ν¬μΈνΈ μ¶©μ „ λ‚΄μ—­ κ²°κ³Ό λ°ν™
        B-->>-A: μ¶©μ „ ν›„ λ³΄μ  ν¬μΈνΈ
    end
```
#### μ£Όμ” λ‚΄μ© μ”μ•½
- 1οΈβƒ£: ν¬μΈνΈ μ¶©μ „ μ”μ²­ μ‹ μµλ€ μ¶©μ „ κΈμ•΅μ€ 500λ§μ›κΉμ§€ μ¶©μ „ κ°€λ¥
- 4οΈβƒ£: ν¬μΈνΈ μ΅°ν κ²°κ³Όμ— ν¬μΈνΈ μ¶©μ „ μ”μ²­μ‹ λ³΄λ‚΄μ¤€ ν¬μΈνΈ ν•©ν•λ‹¤. (λ§μΌ ν¬μΈνΈ μ΅°ν κ²°κ³Όκ°€ μ—†μ„ κ²½μ° λ³΄μ ν¬μΈνΈλ¥Ό 0μ›μΌλ΅ ν•κ³  ν¬μΈνΈ μ¶©μ „ν•λ‹¤.)
- 5οΈβƒ£: μ΄ ν¬μΈνΈκ°€ 0λ―Έλ§, 1000λ§μ› μ΄κ³Ό μΌ κ²½μ° μ¶©μ „ μ‹¤ν¨ (InvalidAmountException)

## π μƒν’
### μƒν’ μ΅°ν
```mermaid
sequenceDiagram
    autonumber
    participant A as ProductController
    participant B as ProductService
    participant C as ProductRepository
    A->>+B: μƒν’ μ΅°ν
    B->>+C: μƒν’ μ •λ³΄ λ° μ¬κ³  μ •λ³΄ μ”μ²­
    alt μƒν’μ΄ μ—†μ„ κ²½μ°
        C-->>B: μƒν’ μ—†μ λ°ν™
        B-->>A: μ¬κ³  μ—†μ
    end
    C-->>-B: μƒν’ μ •λ³΄ λ° μ¬κ³  μ •λ³΄ λ°ν™
    B-->>-A: μƒν’ μ΅°ν κ²°κ³Ό
```
- 3οΈβƒ£ ~ 4οΈβƒ£ : Repository μ—μ„ μƒν’μ΄ μ—†μ„ κ²½μ° false λ°ν™, μƒν’ μ΅°ν μ‹¤ν¨ (ProductNotFoundException)

### μΈκΈ°μƒν’ μ €μ¥
```mermaid
sequenceDiagram
    autonumber
    participant A as μ¤μΌ€μ¥΄λ¬
    participant B as λ°°μΉ
    participant C as DB
    participant D as Redis
    A-)B: μΈκΈ° μƒν’ λ°°μΉ μ”μ²­
    activate B
    B->>+C: μµκ·Ό 3μΌκ°„ μƒν’ νλ§¤ κΈ°λ΅ μ”μ²­
    C-->>-B: μΈκΈ°μƒν’ 5κ° μƒν’ μ΅°ν κ²°κ³Ό
    B->>+D: μΈκΈ° μƒν’ ν’λ© μ €μ¥
    D-->>-B: μΈκΈ°μƒν’ μ €μ¥ μ™„λ£
    deactivate B   
```
- 1οΈβƒ£ : λ§¤ 12μ‹κ°„ λ§λ‹¤ ν•΄λ‹Ή λ°°μΉ μ‹¤ν–‰

### μΈκΈ°μƒν’ μ΅°ν
```mermaid
sequenceDiagram
    autonumber
    participant A as ProductController
    participant B as ProductService
    participant C as Redis
    A->>+B: μΈκΈ°μƒν’ μ΅°ν μ”μ²­
    B->>+C: μΈκΈ°μƒν’ 5κ° μƒν’ μ΅°ν μ”μ²­
    C-->>-B: μΈκΈ°μƒν’ 5κ° μƒν’ μ΅°ν κ²°κ³Ό
    B-->>-A: μΈκΈ° μƒν’
```
## ποΈ μΏ ν°
### μΏ ν° μ„ μ°©μ λ°κΈ‰
```mermaid
sequenceDiagram
    autonumber
    participant A as CouponController
    participant B as CouponService
    participant C as CouponRepository
    participant D as UserCouponService
    participant E as UsersCouponRepository
    A->>+B: μΏ ν° λ°κΈ‰ μ”μ²­
    B->>+C: μΏ ν° μ •λ³΄ μ”μ²­
    C-->>-B: μΏ ν° μ •λ³΄ μ΅°ν κ²°κ³Ό
    B->>B: μ΄λ―Έ λ³΄μ ν• μΏ ν°μΈμ§€ ν™•μΈ
    alt μ΄λ―Έ λ³΄μ μ¤‘μΈ μΏ ν°μΈ κ²½μ°
        B-->>A: λ°κΈ‰ κ±°λ¶€(μ¤‘λ³µλ μΏ ν°)
    else μ”μ—¬ μΏ ν°μ΄ μ—†λ” κ²½μ°
        B-->>A: λ°κΈ‰ κ±°λ¶€(μΏ ν° μ—†μ)
    else μ”μ—¬ μΏ ν°μ΄ μμ„ κ²½μ°
        critical μ”μ—¬ μΏ ν° μ°¨κ°
            B->>+C: μ”μ—¬ μΏ ν° μ°¨κ° μ”μ²­
            C-->>-B: μΏ ν° μ°¨κ° μ™„λ£
        end
        B->>+D: μΏ ν° μ •λ³΄ λ“±λ΅ μ”μ²­
        D->>+E: μ μ € μΏ ν° λ“±λ΅ μ”μ²­
        E-->>-D: μ μ € μΏ ν° λ“±λ΅ μ™„λ£
        D-->>-B: μΏ ν° μ •λ³΄ λ“±λ΅ μ™„λ£
        B-->>-A: μΏ ν° λ°κΈ‰
    end
```
- 5οΈβƒ£: λ™μΌν• μΏ ν°μ„ 2κ°μ΄μƒ λ³΄μ  κΈμ§€(DuplicateCouponException)
- 6οΈβƒ£: μ”μ—¬ μΏ ν°μ΄ μ—†λ” κ²½μ°(CouponOutOfInventoryException)
- 7οΈβƒ£~ 8οΈβƒ£: λ™μ‹μ„± μ μ–΄λ¥Ό ν†µν•΄ μλ² λ³΄μ¥

## π’³ κ²°μ 
### μƒν’ μ£Όλ¬Έ
```mermaid
sequenceDiagram
    autonumber
    participant A as OrderController
    participant B as Order
    participant C as Product
    participant D as OrderItems
    A->>+B: μ£Όλ¬Έ μ”μ²­
    B->>+C: μƒν’ μ •λ³΄ μ΅°ν
    C-->>-B: μƒν’ μ •λ³΄ λ°ν™
    B->>B: μƒν’ μ¬κ³  ν™•μΈ
    alt μƒν’ μ¬κ³  λ¶€μ΅±ν• κ²½μ°
        B-->>A: μ£Όλ¬Έ λ¶κ°€
    else μƒν’μ μ¬κ³ κ°€ λ¨λ‘ μμ„ κ²½μ°
        B->>+D: μƒν’ κ°λ³„ μ •λ³΄ μ €μ¥ μ”μ²­
        D-->>-B: μƒν’ κ°λ³„ μ •λ³΄ μ €μ¥ μ™„λ£
    end
    B-->>-A: μ£Όλ¬Έ μ™„λ£
```
- 5οΈβƒ£: μ£Όλ¬Έ λ¶κ°€ μμ™Έ (InvalidOrderStateException), μ¬κ³  λ¶€μ΅± μ ν’λ…, λ¶€μ΅±ν• μ¬κ³  λ°ν™

### μƒν’ κ²°μ 
```mermaid
sequenceDiagram
    autonumber
    participant A as OrderController
    participant B as Order
    participant C as OrderItems
    participant D as Product
    participant E as UsersCoupon
    participant F as Users
    participant G as λ°μ΄ν„° ν”λ«νΌ
    A->>+B: κ²°μ  μ”μ²­
    B->>+C: κµ¬λ§¤ μƒν’ μ •λ³΄ μ”μ²­
    C-->>-B: κµ¬λ§¤ μƒν’ μ •λ³΄ λ°ν™
    critical μƒν’ μ¬κ³  μ°¨κ°
        B->>+D: μƒν’μ μ¬κ³  μ°¨κ° μ”μ²­
        alt μ¬κ³  λ¶€μ΅±ν• κ²½μ°
            D-->>A: κ²°μ  λ¶κ°€ μμ™Έ
        else κ²°μ  κ°€λ¥ν• κ²½μ°
            D-->>-B: μ¬κ³  μ°¨κ° κ²°κ³Ό μ™„λ£
        end
    end
    B->>+E: μΏ ν° μ •λ³΄ μ”μ²­
    E-->>-B: μΏ ν° μ •λ³΄ λ°ν™
    B->>B: μ΄ κ²°μ  κΈμ•΅ κ³„μ‚°
    B->>+F: ν¬μΈνΈ μ§€λ¶ μ”μ²­ 
    alt κ²°μ κ°€ λ¶κ°€λ¥ν• κ²½μ°
        F-->>A: μ”μ—¬ ν¬μΈνΈ λ¶€μ΅± μμ™Έ
    else κ²°μ  κ°€λ¥ν• κ²½μ°
        F-->>-B: ν¬μΈνΈ μ°¨κ° μ™„λ£
    end
    B-->>-A: κ²°μ  μ™„λ£
    A->>+G: μ£Όλ¬Έ μ •λ³΄ λ°μ΄ν„° ν”λ«νΌμ— μ „μ†΅
    G-->>-A: μ£Όλ¬Έ μ •λ³΄ μ „μ†΅ μ™„λ£
```
- 4οΈβƒ£~6οΈβƒ£: λ™μ‹μ„± μ μ–΄λ¥Ό ν†µν•΄ λ¬Όν’ μ¬κ³  μ°¨κ° μ‹ μλ² λ³΄μ¥
- 9οΈβƒ£: λ¬Όν’λ“¤μ μ΄ κΈμ•΅μ• μ„ μΏ ν°μ ν• μΈ κΈμ•΅λ§νΌ μ°¨κ°